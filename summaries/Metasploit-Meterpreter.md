# Metasploit: Meterpreter

## Introduction

Meterpreter is a Metasploit payload that supports the penetration testing process with many valuable components. Meterpreter will run on the target system and act as an agent within a command and control architecture.

Meterpreter runs on the target system but is not installed on it. It runs in memory and does not write itself to the disk on the target. This feature aims to avoid being detected during antivirus scans.

Meterpreter also aims to avoid being detected by network-based IPS (Intrusion Prevention System) and IDS (Intrusion Detection System) solutions by using encrypted communication with the server where Metasploit runs (typically your attacking machine). If the target organization does not decrypt and inspect encrypted traffic (e.g. HTTPS) coming to and going out of the local network, IPS and IDS solutions will not be able to detect its activities.

Meterpreter is pretty stealthy but still most antiviruses will detect it. For example if you have a session to a windows machine and you get the PID of meterpreter (for example it might have name like spoolsv.exe) and step further too look at DLLs usde by its process using `tasklist /m /fi "pid eq <pid_of_meterpreter>"` you wouldn't get any meterpreter name mentioned somewhere. Meterpreter will establish an encrypted (TLS) communication channel with the attacker's system.

## Flavors & Versions

Metasploit payloads can be initially divided into two categories; inline (also called single) and staged. Staged payloads are sent to the target in two steps. An initial part is installed (the stager) and requests the rest of the payload. This allows for a smaller initial payload size. The inline payloads are sent in a single step. Meterpreter payloads are also divided into stagged and inline versions.

To list available Meterpreter versions use `msfvenom --list payloads | grep meterpreter`

Versions are available for Android, Apple iOS, Java, Linux, OSX, PHP, Python, Windows platforms.

To choose whcih version to use:

1. Target OS
2. Components available on taget
3. Network connection type

If you are not using Meterpreter as a standalone payload generated by Msfvenom, your choice may also be limited by the exploit.

## Commands

By typing `help` on any Meterpreter session you can list all available commands. Every version has different command options and it can be checked with `whow options`.

Meterpreter will provide three primary categories of tools:

- Built-in commands
- Meterpreter tools
- Meterpreter scripting

By running `help` you can see each commands are listed under different categories. The categories are: Core, File system, Networking, System, User interface, Webcam, Audio output, Elevate, Password database and, Timestomp.

## Post-Exploitation with Meterpreter

Once you found an exploit and had a session you can connect to the device and continue with post-exploitation. Use `sessions` to list all the available sessions and connect with `sessions -i <session_id>`.

The post-exploitation phase will have several goals; Meterpreter has functions that can assist all of them.

- Gathering further information about the target system.
- Looking for interesting files, user credentials, additional network interfaces, and generally interesting information on the target system.
- Privilege escalation.
- Lateral movement.

### Important commands

- `use priv` you need to run prior to using `getsystem`.
- `getsystem` attempt to elevate your privilege to that of local system.
- `getuid` display the user with which it is currently running.
- `ps` list running processes with their PIDs.
- `migrate <pid>` migrate to another process to interact with it (for ex. word.exe to get the key strokes using `keyscan_start`). Note: Migrating to another process may help you to have a more stable Meterpreter session. But be careful, you may lose your user privileges if you migrate from a higher privileged (system) user to a process started by a lower privileged (webserver) user and may not be able to gain them back.
- `hashdump` list the content of the SAM database for windows systems. These passwords are stored in the NTLM format. You cna use http://crackstation.net/ to decipher the hashes.
- `search -f <file_name>` useful to locate files with potentially juicy information (for ex. `search -f *.txt`)
- `shell` launch a regular command-line shell on the target system. Pressing CTRL+Z will help you go back to the Meterpreter shell.
- `load python` run Python code natively on target machine.
- `load kiwi` or `load Mimikatz` credential-oriented operations, such as dumping passwords and hashes, dumping passwords in memory, generating golden tickets.
